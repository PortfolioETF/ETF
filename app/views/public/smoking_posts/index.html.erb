<div id="output"></div>
  <p><button onclick="saveMyLocation()" type="button" >投稿する</button></p>
  <div id="form-post">
    <%= form_with model: @location, local: true, url: smoking_posts_path do |f| %>
      <%= f.hidden_field :latitude, id: "smoking-post-latitude"%>
      <%= f.hidden_field :longitude, id: "smoking-post-longitude" %>
    <%= f.fields_for :smoking_posts do |smoking_post| %>
      <%= image_tag '', id: "post-img" %>
      <div>
        <%= smoking_post.file_field :image_id, id: "smoking-post-img", input_html: {accept: @smoking_post.set_extension} %>
      </div>
      <div>
        <%= smoking_post.text_field :title, id: "smoking-post-title" %>
      </div>
      <div>
        <%= smoking_post.text_area :body, id: "smoking-post-body" %>
      </div>
    <% end %>
      <%= f.submit '投稿を作成' %>
      <%# type="button"指定がないとparams二つ飛ぶ %>
    <% end %>
  </div>
<div id="map" style="width:100%;height:300px;"></div>



<script>
window.onload = function(){
  confirmBrowser();
  function success(position) {
    var locations = JSON.parse('<%= raw @locations%>');
    var latitude = position.coords.latitude;
    var longitude = position.coords.longitude;
    var latlng = new google.maps.LatLng(latitude, longitude);
    var map = new google.maps.Map(document.getElementById('map'), {
      zoom: 15, center: latlng,
    });
    new google.maps.Marker({
      map: map, position: latlng,
    });
    locations.forEach(function(location){
      new google.maps.Marker({
        map: map,
        position: new google.maps.LatLng(location.latitude, location.longitude),
      });
    });
  };
  function error(){
    output.innerHTML = "現在地を取得できません";
  };
  navigator.geolocation.getCurrentPosition(success, error);
};

function saveMyLocation() {
  confirmBrowser();
  function saveSuccess(position) {
    postFormDisplay();
    var latitude  = position.coords.latitude;//緯度
    var longitude = position.coords.longitude;//経度
    var title = $("#smoking-post-title").val();
    var body = $("#smoking-post-body").val();
    $.ajax({
      url: "/locations/new",
      type: "GET",
      data: {latlong: {longitude: longitude, latitude: latitude}},
    }).done(function(data){
      $("#smoking-post-latitude").val(data.latitude);
      $("#smoking-post-longitude").val(data.longitude);
    })
  };
  function saveError() {
    output.innerHTML = "現在地を取得できません";
  };
  navigator.geolocation.getCurrentPosition(saveSuccess, saveError);//成功と失敗を判断
};

function confirmBrowser(){
    var output = document.getElementById('output');
    if(!navigator.geolocation){
    output.innerHTML = "<p>EasyToFindはあなたのブラウザーでサポートされていない可能性があります</p>";
    return;
  };
};



 $(function() {
      function readURL(input) {
        if (input.files && input.files[0]) {
          var reader = new FileReader();
          reader.onload = function (e) {
            $('#post-img').attr('src', e.target.result);
          }
        reader.readAsDataURL(input.files[0]);
        }
      }
    $("#smoking-post-img").change(function(){
     readURL(this);
    });
 });

</script>
